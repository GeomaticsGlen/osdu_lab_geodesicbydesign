<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reference Schema Browser</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    label, select, input, button { margin: 0.5rem 0; display: block; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background-color: #f0f0f0; }
    #error { color: red; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Reference Schema Browser</h1>

  <label>
    Data Partition ID:
    <input type="text" id="partition" placeholder="e.g. opendes" />
  </label>

  <label>
    Reference Schema Kind:
    <select id="schemaDropdown"></select>
  </label>

  <button onclick="loadSchemaFields()">Browse Fields</button>
  <div id="error"></div>
  <table id="fieldsTable"></table>

  <script>
    async function populateSchemaDropdown() {
      const dropdown = document.getElementById("schemaDropdown");
      try {
        const response = await fetch("/api/storage/v2/records/kinds");
        const kinds = await response.json();
        const referenceKinds = kinds.filter(k => k.includes("reference-data--"));
        dropdown.innerHTML = referenceKinds.map(k => `<option value="${k}">${k}</option>`).join("");
      } catch (err) {
        console.error("Failed to load kinds:", err);
      }
    }

    async function loadSchemaFields() {
      const partition = document.getElementById("partition").value;
      const kind = document.getElementById("schemaDropdown").value;
      const errorDiv = document.getElementById("error");
      const table = document.getElementById("fieldsTable");
      errorDiv.textContent = "";
      table.innerHTML = "";

      if (!partition || !kind) {
        errorDiv.textContent = "Please enter a partition ID and select a schema kind.";
        return;
      }

      try {
        const response = await fetch(`/api/storage/v2/records/flat/filter?kind=${encodeURIComponent(kind)}`, {
          headers: { "data-partition-id": partition }
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || "API error");
        }

        const records = await response.json();
        if (records.length === 0) {
          table.innerHTML = "<tr><td>No records found.</td></tr>";
          return;
        }

        const fieldTypes = {};
        for (const record of records) {
          for (const [key, value] of Object.entries(record)) {
            if (["id", "kind"].includes(key)) continue;
            const type = Array.isArray(value) ? "array" : typeof value;
            fieldTypes[key] = fieldTypes[key] || new Set();
            fieldTypes[key].add(type);
          }
        }

        const headers = ["Field", "Types"];
        const thead = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";
        const rows = Object.entries(fieldTypes).map(([field, types]) =>
          `<tr><td>${field}</td><td>${Array.from(types).join(", ")}</td></tr>`
        ).join("");

        table.innerHTML = thead + rows;

      } catch (err) {
        errorDiv.textContent = "Error: " + err.message;
      }
    }

    window.onload = populateSchemaDropdown;
  </script>
</body>
</html>
